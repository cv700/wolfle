<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Werewolf Game</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
    <style>
        @keyframes wolfHowl {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        @keyframes spiderDrop {
            0% { top: -50px; }
            50% { top: 100px; }
            100% { top: -50px; }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .flicker {
            animation: flicker 0.5s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(0, 20px); }
            100% { transform: translate(0, 0); }
        }

        .floating-emoji {
            position: absolute;
            opacity: 0.2;
            pointer-events: none;
            z-index: -1;
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const EmojiWerewolfGame = () => {
            // Define emoji sets for the game
            const professionEmojis = [
                ['üë®‚Äçüöí', 'üë©‚Äçüöí'], // Firefighters
                ['üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è'], // Health workers
                ['üë®‚Äçüåæ', 'üë©‚Äçüåæ'], // Farmers
                ['üë®‚Äçüè´', 'üë©‚Äçüè´'], // Teachers
                ['üë®‚Äçüç≥', 'üë©‚Äçüç≥'], // Chefs
                ['üë®‚Äçüî¨', 'üë©‚Äçüî¨'], // Scientists
                ['üë®‚Äçüíº', 'üë©‚Äçüíº'], // Office workers
                ['üë®‚Äç‚úàÔ∏è', 'üë©‚Äç‚úàÔ∏è'], // Pilots
                ['üëÆ‚Äç‚ôÇÔ∏è', 'üëÆ‚Äç‚ôÄÔ∏è'], // Police officers
                ['üïµÔ∏è‚Äç‚ôÇÔ∏è', 'üïµÔ∏è‚Äç‚ôÄÔ∏è'], // Detectives
                // Add more profession pairs as needed
            ];

            const otherEmojis = ['üßô‚Äç‚ôÇÔ∏è', 'ü¶π‚Äç‚ôÄÔ∏è', 'ü§°', 'üßù‚Äç‚ôÄÔ∏è', 'üë∏', 'üéÉ', 'üëª', 'ü¶á', 'üï∑Ô∏è', 'üï∏Ô∏è'];

            const gridSize = 7; // Define the size of the game grid

            // State variables
            const [gameBoard, setGameBoard] = React.useState([]);
            const [werewolfIndex, setWerewolfIndex] = React.useState(-1);
            const [lastClickedIndex, setLastClickedIndex] = React.useState(-1);
            const [lastClickTime, setLastClickTime] = React.useState(0);
            const [timer, setTimer] = React.useState(60);
            const [score, setScore] = React.useState(0);
            const [showWolfAnimation, setShowWolfAnimation] = React.useState(false);
            const [isGameOver, setIsGameOver] = React.useState(false);
            const [message, setMessage] = React.useState('');
            const [gameState, setGameState] = React.useState('home');
            const [highScore, setHighScore] = React.useState(() => {
                const saved = localStorage.getItem('highScore');
                return saved !== null ? parseInt(saved, 10) : 0;
            });
            const [error, setError] = React.useState(null);

            // Effect for game timer
            React.useEffect(() => {
                if (gameState === 'playing' && timer > 0) {
                    const interval = setInterval(() => {
                        setTimer(prevTimer => prevTimer - 1);
                    }, 1000);
                    return () => clearInterval(interval);
                } else if (timer === 0) {
                    endGame(false);
                }
            }, [gameState, timer]);

            // Initialize the game
            const initGame = () => {
                try {
                    const totalTiles = gridSize * gridSize;
                    const requiredPairs = Math.floor(totalTiles / 2) - 1; // -1 for the werewolf

                    if (requiredPairs > professionEmojis.length + otherEmojis.length) {
                        throw new Error("Not enough emojis for the grid size");
                    }

                    // Select random professions
                    const shuffledProfessions = professionEmojis.sort(() => 0.5 - Math.random());
                    const selectedProfessions = shuffledProfessions.slice(0, requiredPairs);

                    // For each selected profession, randomly choose male or female
                    const selectedEmojis = selectedProfessions.map(pair => pair[Math.floor(Math.random() * 2)]);

                    // If we need more emojis, add from otherEmojis
                    while (selectedEmojis.length < requiredPairs) {
                        const randomOtherEmoji = otherEmojis[Math.floor(Math.random() * otherEmojis.length)];
                        if (!selectedEmojis.includes(randomOtherEmoji)) {
                            selectedEmojis.push(randomOtherEmoji);
                        }
                    }

                    // Double the selected emojis to create pairs
                    const allEmojis = [...selectedEmojis, ...selectedEmojis];

                    // Add the werewolf
                    const werewolfEmoji = 'üê∫';
                    const newWerewolfIndex = Math.floor(Math.random() * totalTiles);
                    allEmojis.splice(newWerewolfIndex, 0, werewolfEmoji);

                    // Shuffle the final array
                    const shuffledEmojis = allEmojis.sort(() => 0.5 - Math.random());

                    setGameBoard(shuffledEmojis.map(emoji => ({ 
                        emoji, 
                        isClicked: false,
                        isMatched: false
                    })));
                    setWerewolfIndex(newWerewolfIndex);
                    setIsGameOver(false);
                    setTimer(60);
                    setScore(0);
                    setMessage('');
                    setGameState('playing');
                    setError(null); // Clear any previous errors
                } catch (err) {
                    console.error("Error initializing game:", err);
                    setError("Failed to start the game. Please try again.");
                }
            };

            // Handle tile clicks
            const handleTileClick = (index) => {
                try {
                    if (gameState !== 'playing' || gameBoard[index].isMatched) return;

                    const currentTime = new Date().getTime();
                    if (currentTime - lastClickTime < 300 && lastClickedIndex === index) {
                        // Double tap detected
                        if (index === werewolfIndex) {
                            // Correct werewolf guess
                            setShowWolfAnimation(true);
                            setTimeout(() => {
                                setShowWolfAnimation(false);
                                setScore(prevScore => prevScore + 1);
                                resetBoard();
                            }, 1000);
                        } else {
                            // Incorrect werewolf guess
                            endGame(false);
                        }
                    } else {
                        // Single tap - reveal tile
                        setGameBoard(prevBoard => {
                            const newBoard = [...prevBoard];
                            newBoard[index] = {...newBoard[index], isClicked: !newBoard[index].isClicked};
                            return newBoard;
                        });
                        checkMatch(index);
                    }
                    setLastClickTime(currentTime);
                    setLastClickedIndex(index);
                } catch (err) {
                    console.error("Error handling tile click:", err);
                    setError("An error occurred. Please try again.");
                }
            };

            // Reset the game board after finding a werewolf
            const resetBoard = () => {
                const totalTiles = gridSize * gridSize;
                const requiredPairs = Math.floor(totalTiles / 2) - 1; // -1 for the werewolf

                // Select random professions
                const shuffledProfessions = professionEmojis.sort(() => 0.5 - Math.random());
                const selectedProfessions = shuffledProfessions.slice(0, requiredPairs);

                // For each selected profession, randomly choose male or female
                const selectedEmojis = selectedProfessions.map(pair => pair[Math.floor(Math.random() * 2)]);

                // If we need more emojis, add from otherEmojis
                while (selectedEmojis.length < requiredPairs) {
                    const randomOtherEmoji = otherEmojis[Math.floor(Math.random() * otherEmojis.length)];
                    if (!selectedEmojis.includes(randomOtherEmoji)) {
                        selectedEmojis.push(randomOtherEmoji);
                    }
                }

                // Double the selected emojis to create pairs
                const allEmojis = [...selectedEmojis, ...selectedEmojis];

                // Add the werewolf
                const werewolfEmoji = 'üê∫';
                const newWerewolfIndex = Math.floor(Math.random() * totalTiles);
                allEmojis.splice(newWerewolfIndex, 0, werewolfEmoji);

                // Shuffle the final array
                const shuffledEmojis = allEmojis.sort(() => 0.5 - Math.random());

                setGameBoard(shuffledEmojis.map(emoji => ({ 
                    emoji, 
                    isClicked: false,
                    isMatched: false
                })));
                setWerewolfIndex(newWerewolfIndex);
            };

            // Check for matching pairs
            const checkMatch = (index) => {
                const currentEmoji = gameBoard[index].emoji;
                const matchIndex = gameBoard.findIndex((tile, i) => 
                    i !== index && 
                    tile.emoji === currentEmoji && 
                    tile.isClicked && 
                    !tile.isMatched
                );

                if (matchIndex !== -1) {
                    setGameBoard(prevBoard => {
                        const newBoard = [...prevBoard];
                        newBoard[index] = {...newBoard[index], isMatched: true};
                        newBoard[matchIndex] = {...newBoard[matchIndex], isMatched: true};
                        return newBoard;
                    });
                }
            };

            // Get arrow emoji pointing towards the werewolf
            const getArrowEmoji = (fromIndex, toIndex) => {
                const fromRow = Math.floor(fromIndex / gridSize);
                const fromCol = fromIndex % gridSize;
                const toRow = Math.floor(toIndex / gridSize);
                const toCol = toIndex % gridSize;
                
                const deltaY = toRow - fromRow;
                const deltaX = toCol - fromCol;
                
                if (deltaY < 0) {
                    if (deltaX < 0) return '‚ÜñÔ∏è';
                    if (deltaX === 0) return '‚¨ÜÔ∏è';
                    return '‚ÜóÔ∏è';
                }
                if (deltaY === 0) {
                    if (deltaX < 0) return '‚¨ÖÔ∏è';
                    if (deltaX > 0) return '‚û°Ô∏è';
                }
                if (deltaY > 0) {
                    if (deltaX < 0) return '‚ÜôÔ∏è';
                    if (deltaX === 0) return '‚¨áÔ∏è';
                    return '‚ÜòÔ∏è';
                }
                return ''; // This should never happen
            };

            // End the game
            const endGame = (isWin) => {
                setIsGameOver(true);
                setGameState('gameOver');
                setMessage(isWin ? "Time's up!" : "Wrong guess! Game over.");
                setGameBoard(prevBoard => {
                    const newBoard = [...prevBoard];
                    newBoard[werewolfIndex] = {...newBoard[werewolfIndex], emoji: 'üê∫'};
                    return newBoard;
                });
                if (score > highScore) {
                    setHighScore(score);
                    localStorage.setItem('highScore', score.toString());
                }
            };

            // Share score on social media
            const shareScore = () => {
                try {
                    const shareText = `I found ${score} werewolves in Emoji Werewolf! Can you beat my score? Play now!`;
                    const shareUrl = window.location.href;

                    if (navigator.share) {
                        navigator.share({
                            title: 'Emoji Werewolf Score',
                            text: shareText,
                            url: shareUrl,
                        }).then(() => console.log('Successful share'))
                        .catch((error) => {
                            console.error('Error sharing:', error);
                            setError("Failed to share. Please try again.");
                        });
                    } else {
                        const fallbackUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                        window.open(fallbackUrl, '_blank');
                    }
                } catch (err) {
                    console.error("Error sharing score:", err);
                    setError("Failed to share score. Please try again.");
                }
            };

            // Start a new game
            const startGame = () => {
                initGame();
                setGameState('playing');
            };

            // Component for wolf found animation
            const WolfAnimation = () => (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: '100%',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    backgroundColor: 'rgba(0,0,0,0.7)',
                    zIndex: 1000,
                }}>
                    <div style={{fontSize: '10em', animation: 'wolfHowl 1s ease-in-out'}}>üê∫</div>
                </div>
            );

            // Component for game over screen
            const GameOverScreen = () => (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: '100%',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    alignItems: 'center',
                    backgroundColor: 'rgba(0,0,0,0.7)',
                    color: 'white',
                    zIndex: 1000,
                }}>
                    <h2>Game Over</h2>
                    <p>Your score: {score}</p>
                    <p>High score: {highScore}</p>
                    <button onClick={initGame} style={{
                        fontSize: '1.2em',
                        padding: '10px 20px',
                        background: '#ff6600',
                        color: 'white',
                        border: 'none',
                        borderRadius: '5px',
                        cursor: 'pointer',
                        marginTop: '20px',
                    }}>
                        Play Again
                    </button>
                    <button onClick={shareScore} style={{
                        fontSize: '1.2em',
                        padding: '10px 20px',
                        background: '#4CAF50',
                        color: 'white',
                        border: 'none',
                        borderRadius: '5px',
                        cursor: 'pointer',
                        marginTop: '10px',
                    }}>
                        Share Score
                    </button>
                </div>
            );

            // Component for displaying error messages
            const ErrorMessage = () => (
                error && (
                    <div style={{
                        backgroundColor: '#ffcccc',
                        color: '#cc0000',
                        padding: '10px',
                        margin: '10px 0',
                        borderRadius: '5px',
                        fontWeight: 'bold'
                    }}>
                        {error}
                    </div>
                )
            );

            // Component for home screen
            const HomeScreen = () => (
                <div style={{
                    background: '#FFA500',
                    minHeight: '100vh',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    alignItems: 'center',
                    color: '#000000',
                    fontFamily: '"Creepster", cursive',
                    padding: '20px',
                    boxSizing: 'border-box',
                    position: 'relative',
                    overflow: 'hidden'
                }}>
                    <FloatingBackgroundEmojis />
                    <h1 style={{
                        fontSize: 'clamp(36px, 8vw, 64px)', 
                        textShadow: '2px 2px 4px #000000', 
                        textAlign: 'center'
                    }}>
                        üê∫ Emoji Werewolf üéÉ
                    </h1>
                    
                    <div style={{
                        fontSize: 'clamp(14px, 3vw, 18px)',
                        maxWidth: '600px', 
                        width: '90%',
                        textAlign: 'center', 
                        marginBottom: '20px',
                        backgroundColor: 'rgba(255, 255, 255, 0.7)',
                        padding: '20px',
                        borderRadius: '10px',
                        boxShadow: '0 0 10px rgba(0,0,0,0.3)',
                        animation: 'fadeIn 2s ease-in'
                    }}>
                        <p>Detective, welcome to our humble emoji village. A werewolf is afoot.</p>
                        <p>You have to double click them to accuse them. Non-werewolves have a buddy who will vouch for them.</p>
                        <p>Identify matching pairs to get clues.</p>
                        <p>How many nights can you survive?</p>
                    </div>

                    <div style={{fontSize: 'clamp(24px, 6vw, 48px)', marginBottom: '20px'}}>
                        üëª ü¶á üï∑Ô∏è üï∏Ô∏è üßô‚Äç‚ôÇÔ∏è ü¶π‚Äç‚ôÄÔ∏è üë®‚Äçüî¨ ü§° üßù‚Äç‚ôÄÔ∏è üë∏
                    </div>

                    <button 
                        onClick={startGame}
                        style={{
                            fontSize: 'clamp(18px, 4vw, 24px)',
                            padding: '10px 20px',
                            background: '#ff6600',
                            color: 'white',
                            border: 'none',
                            borderRadius: '5px',
                            cursor: 'pointer',
                            boxShadow: '0 0 10px #ff9900'
                        }}
                    >
                        Start Investigation
                    </button>
                    <SpiderAnimation />
                </div>
            );

            // Component for spider animation
            const SpiderAnimation = () => (
                <div style={{
                    position: 'absolute',
                    top: '10px',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    fontSize: '2em',
                    animation: 'spiderDrop 5s infinite'
                }}>
                    üï∑Ô∏è
                </div>
            );

            // Component for visual timer
            const VisualTimer = ({ timer, maxTime }) => (
                <div style={{
                    width: '100%',
                    height: '10px',
                    backgroundColor: '#ddd',
                    borderRadius: '5px',
                    overflow: 'hidden',
                    marginBottom: '10px'
                }}>
                    <div style={{
                        width: `${(timer / maxTime) * 100}%`,
                        height: '100%',
                        backgroundColor: timer > 10 ? '#4CAF50' : '#f44336',
                        transition: 'width 1s linear, background-color 0.5s'
                    }} />
                </div>
            );

            // Component for floating background emojis
            const FloatingBackgroundEmojis = () => {
                const emojis = ['üåô', 'üåü', 'ü¶á', 'üï∏Ô∏è', 'üï∑Ô∏è', 'üéÉ'];
                const [floatingEmojis, setFloatingEmojis] = React.useState([]);

                React.useEffect(() => {
                    const newEmojis = [];
                    for (let i = 0; i < 10; i++) {
                        newEmojis.push({
                            emoji: emojis[Math.floor(Math.random() * emojis.length)],
                            style: {
                                left: `${Math.random() * 100}vw`,
                                top: `${Math.random() * 100}vh`,
                                fontSize: `${Math.random() * 20 + 10}px`,
                                animationDuration: `${Math.random() * 2 + 2}s`,
                                animationDelay: `${Math.random() * 2}s`
                            }
                        });
                    }
                    setFloatingEmojis(newEmojis);
                }, []);

                return (
                    <>
                        {floatingEmojis.map((item, index) => (
                            <div 
                                key={index} 
                                className="floating-emoji" 
                                style={item.style}
                            >
                                {item.emoji}
                            </div>
                        ))}
                    </>
                );
            };

            // Render home screen if game state is 'home'
            if (gameState === 'home') {
                return <HomeScreen />;
            }

            // Main game render
            return (
                <div className="game-container" style={{
                    fontFamily: 'Arial, sans-serif', 
                    textAlign: 'center', 
                    maxWidth: '100%',
                    margin: '0 auto', 
                    padding: '10px',
                    backgroundColor: '#FFA500',
                    minHeight: '100vh',
                    boxSizing: 'border-box',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    position: 'relative',
                    overflow: 'hidden'
                }}>
                    <FloatingBackgroundEmojis />
                    <h1 style={{fontSize: 'clamp(24px, 5vw, 36px)'}}>Emoji Werewolf Game</h1>
                    <VisualTimer timer={timer} maxTime={60} />
                    <div style={{
                        height: '20px', 
                        marginTop: '10px', 
                        fontSize: 'clamp(14px, 4vw, 18px)', 
                        fontWeight: 'bold'
                    }}>
                        Time: {Math.floor(timer / 60)}:{(timer % 60).toString().padStart(2, '0')}
                    </div>
                    <div style={{
                        height: '20px', 
                        marginTop: '10px', 
                        fontSize: 'clamp(14px, 4vw, 18px)', 
                        fontWeight: 'bold'
                    }}>
                        Score: {score}
                    </div>
                    <div className="game-board" style={{
                        display: 'grid',
                        gap: '5px',
                        margin: '20px auto',
                        gridTemplateColumns: `repeat(${gridSize}, 1fr)`,
                        width: '90vmin',
                        height: '90vmin',
                        maxWidth: '600px',
                        maxHeight: '600px',
                        backgroundColor: '#FFF',
                        padding: '10px',
                        borderRadius: '10px'
                    }}>
                        {gameBoard.map((tile, index) => (
                            <div 
                                key={index} 
                                className={`tile ${tile.isClicked ? 'clicked' : ''}`}
                                style={{
                                    aspectRatio: '1',
                                    fontSize: 'clamp(20px, 8vmin, 30px)',
                                    backgroundColor: tile.isClicked ? '#e0e0e0' : '#fff', 
                                    border: '1px solid #ccc',
                                    display: 'flex',
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                    cursor: 'pointer',
                                    transition: 'transform 0.3s',
                                    touchAction: 'manipulation'
                                }}
                                onClick={() => handleTileClick(index)}
                            >
                                {tile.isMatched ? getArrowEmoji(index, werewolfIndex) : tile.emoji}
                            </div>
                        ))}
                    </div>
                    <div style={{
                        height: '20px', 
                        marginTop: '10px', 
                        fontSize: 'clamp(14px, 4vw, 18px)', 
                        fontWeight: 'bold'
                    }}>
                        {message}
                    </div>
                    {showWolfAnimation && <WolfAnimation />}
                    {gameState === 'gameOver' && <GameOverScreen />}
                </div>
            );
        };

        ReactDOM.render(<EmojiWerewolfGame />, document.getElementById('root'));
    </script>
</body>
</html>
